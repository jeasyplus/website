# TCP协议

TCP 在 OSI 模型的第四层（传输）中运行，为多个设备及其应用程序提供主机到主机的通信。

此外，TCP是一种面向连接的协议。这意味着通过TCP通信的设备必须建立连接。

反过来，连接是通过握手过程建立的，并使连接的设备能够交换消息。

为了建立、管理和关闭连接，TCP 使用控制消息作为设备的信号：

+ SYN：通常用于请求客户端和服务器之间连接的同步消息
+ ACK：用于声明收到特定消息的确认消息
+ FIN：触发客户端和服务器之间正常连接终止的消息
+ RST：中止客户端和服务器之间的连接（强制终止）的消息
  
通过TCP进行的典型通信从三向握手过程开始。此过程使用 SYN 和 ACK 消息在客户端和服务器之间建立连接。因此，连接的实体可以交换消息。

这样，TCP上的典型通信从三次握手过程开始。该过程使用SYN和ACK消息在客户端和服务器之间建立连接。因此，连接的实体可以交换消息。

此外，这些实体会相互确认（ACK）收到的每个消息。

当通信结束时，连接的实体会发送一个FIN消息来关闭连接。

![FIN](https://jeasyplus.com/tcp/tcp-fin.png)


值得强调的是，FIN握手由一对双向握手组成：
+ 第一次握手由发起方发起的第一个FIN消息（步骤1）；
+ 第二次握手是由另一个实体发送的第二个FIN消息时开始（步骤5）

#### TCP复位攻击

如果连接出现问题，实体可以通过发送RST消息来中止连接。
也给了伪造的TCP复位攻击有可乘之机。

在这种情况下，一个恶意代理伪造了一个带有已连接实体寻址信息的RST数据包。

然后，该恶意实体将伪造的数据包发送给这些已连接的实体之一，使用RST消息来中止两个实体之间的连接。




## 状态图

TCP协议在实现连接时并不是靠物理连接，通过维护连接状态来实现连接。

### CLOSED：

初始状态或连接终止状态。表示TCP连接未建立或已经终止。

### LISTEN：

服务器处于等待客户端连接的状态。在该状态下，服务器正在监听指定的端口，准备接受客户端连接请求。

### SYN-SENT：

客户端发送了连接请求（SYN包），等待服务器的确认。在这个状态下，TCP连接正在进行握手的第一阶段。

### SYN-RECEIVED：

服务器接收到客户端的连接请求，发送确认并等待客户端的确认。在这个状态下，TCP连接正在进行握手的第二阶段。

### ESTABLISHED：


连接已经建立，双方可以进行数据传输。在这个状态下，TCP连接已经建立并可以进行数据传输。

### FIN-WAIT-1：

TCP连接终止中的状态。表示本端发送了连接终止请求（FIN包），等待对方确认。

### FIN-WAIT-2：

TCP连接终止中的状态。表示本端已经收到对方发送的连接终止请求（FIN包），等待最后的对方确认。

### CLOSE-WAIT：

表示本端收到对方的连接终止请求（FIN包），并已经发送了确认，等待应用程序关闭连接。

### CLOSING：

表示双方同时发起连接终止请求，进入等待对方确认的状态。

### LAST-ACK：

表示本端已经发送了连接终止请求的确认，等待对方的最后确认。

### TIME-WAIT：

表示连接终止后的等待状态。在这个状态下，连接已经终止，但仍在等待一段时间以确保所有的数据包都被接收。这个状态的持续时间为2倍的最大报文段生存时间（2MSL）。

## CLOSED：

连接彻底关闭，释放所有资源。


## 三个阶段

### 建立连接（Three-Way Handshake）：

**客户端**要与服务器建立连接，首先向服务器发送一个**SYN报文**，进入**SYN-SENT**状态。
```text
client -> SYN : SYN-SENT
```
**服务器**收到客户端的**SYN**报文后，回复一个带有**ACK**和**SYN标志**的报文，表示接受**连接请求**，并进入**SYN-RECEIVED**状态。
```text
-> server -> ACK & SYN : SYN-RECEIVED
```
**客户端**收到服务器的回复，回复一个带有**ACK**标志的报文，表示连接已建立，双方进入**ESTABLISHED**状态，可以进行数据传输。
```text
-> client -> ACK -> server ：ESTABLISHED
```
#### 具体过程：

1、客户端发送建立TCP连接的请求报文，报文中包含**seq**序列号，并将报文中的**SYN**字段置为1，表示需要建立TCP连接。
```
（SYN=1，seq=x，x为随机数值）
```

2、服务端接收并返回响应报文，并随机生成**seq**序列号，且将SYN置为1，将客户端发送的序列号加1放在ACK字段中。
```text
（SYN=1，ACK=x+1，seq=y，y为随机数值）
```
3、客户端收到回复后，将自己的序列号加1，并将服务端的seq加1作为ACK进行回复。
```text
ACK（SYN=1，ACK=y+1，seq=x+1）
```

### 数据传输：

一旦TCP连接进入ESTABLISHED状态，双方可以通过发送和接收数据报文来进行数据传输。发送方将数据封装在TCP报文段中，接收方负责确认收到的数据。

### 终止连接（Four-Way Handshake）：

![FIN](https://jeasyplus.com/tcp/fin-process.png)

**任意一方**（通常是客户端或服务器）想要终止连接时，发送一个带有**FIN**标志的报文，进入FIN-WAIT-1或CLOSE-WAIT状态。
```text
 (S) -> FIN ：FIN-WAIT-1
```

接收方收到FIN报文后，发送一个带有ACK标志的报文进行确认，进入CLOSE-WAIT

```text
 FIN -> (R) -> ACK : CLOSE-WAIT
```

发送方收到确认后，进入FIN-WAIT-2

```text
ACK -> (S) : FIN-WAIT-2
```

最后，接收方在确认**数据已传输完成**后，会再发送一个带有FIN标志的报文，进入LAST-ACK状态。

```text
(R) -> FIN : LAST-ACK
```

最初的发送方收到该报文并回复ACK，然后进入TIME-WAIT状态。

```text
FIN -> (S) -> ACK : TIME-WAIT
```

接收方等待一段时间，然后进入CLOSED状态。

```text
 (R)~ ~ : CLOSED
```
最初的发送方等待一段时间（2MSL，两倍的最大报文段生存时间）后，进入CLOSED状态。

```text
 (S)~ ~ : CLOSED
```

#### 以客户发起断开为例具体说明

客户端发送断开TCP连接请求的报文，表示需要断开TCP连接。
```
（FIN=1，seq=x，x客户端生成）
```

2、服务端接收后返回响应报文，
```
（FIN=1，ACK=x+1，seq=y，y服务端生成）
````

3、服务端返回响应报文后，不会马上断开TCP连接，需要确保数据已经传输完毕，在确认传输数据完毕后，再回复一条报文。
（FIN=1，ACK=x+1，seq=z，z服务端生成）；

4、客户端收到后，会再次回复服务端的请求。
```text
（FIN=1，ACK=z+1，seq=h，h客户端生成）
```
至此TCP断开的4次挥手过程完毕。


### 可靠性

TCP通过多种机制来保证可靠性，其中包括丢包后的重传机制。

#### 序列号与确认应答：

TCP将每个发送的数据包都进行编号，称为序列号。接收方收到数据后，会发送确认应答（ACK）给发送方，告知已经收到数据并确认序列号。如果发送方在一定时间内没有收到确认应答，就会认为数据包丢失，并进行重传。

#### 超时重传：

TCP在发送数据包后启动一个计时器，如果在设定的超时时间内没有收到确认应答，就会认为数据包丢失，触发超时重传，将数据包重新发送。

#### 窗口控制：

TCP采用滑动窗口协议，即发送方可以连续发送一定数量的数据包而不需要等待确认应答。接收方会设置一个接收窗口大小，告知发送方可以接收多少个数据包而不会丢失。通过滑动窗口的机制，TCP可以在一定程度上提高传输效率。

#### 确认应答累积确认：

TCP接收方可以对收到的数据包进行累积确认，即一次性确认多个连续的序列号，减少确认报文的数量，提高效率。

#### 拥塞控制：

TCP会根据网络拥塞情况调整发送速率，以避免网络拥塞。当网络拥塞时，TCP会降低发送速率，防止丢包现象的加剧。

#### 选择确认：

TCP使用选择确认（Selective Acknowledgment，SACK）来告知发送方已经接收到的数据段，从而避免重传整个窗口内的数据，提高重传的效率。

#### 快速重传：

TCP接收方在连续收到相同序列号的重复数据包时，会立即发送重复确认，通知发送方进行快速重传，避免等待超时计时器的触发。


## 滑动窗口协议

滑动窗口协议是TCP协议中用于实现可靠数据传输的关键机制之一。

允许发送方在不等待确认的情况下连续发送多个数据包，从而提高了数据传输的效率。

同时，接收方通过设置一个接收窗口大小来告知发送方可以接收多少个数据包而不会丢失。

滑动窗口协议的基本原理如下：

+ 发送窗口： 发送方维护一个发送窗口，窗口的大小由接收方通告，表示接收方当前能够接收的数据量。

+ 接收窗口：接收方维护一个接收窗口，用于指示发送方可以连续发送哪些序列号的数据包。

+ 序列号：每个发送的数据包都带有一个唯一的序列号，用于标识数据包的顺序。

+ 确认应答：接收方收到数据后，会发送确认应答（ACK）给发送方，告知已经接收到数据并确认序列号。

+ 滑动：发送方在发送一个数据包后，会将发送窗口向前滑动，允许发送下一个数据包。而接收方在收到一批连续的数据包后，会将接收窗口向前滑动，允许接收下一批数据包。

滑动窗口协议也允许接收方灵活地控制可以接收的数据量，避免了发送方发送过多数据导致接收方丢失数据的情况。
