# Redis集群模式

## 主从复制模式

通过持久化功能，Redis保证了即使在服务器重启的情况下也不会丢失（或少量丢失）数据，
 
但由于数据是存储在一台服务器上的，如果服务器硬盘出现故障等问题，数据依然会丢失。

为了避免单点故障，需要在不同的服务器上形成多个副本，即使一台服务器出现故障，其他服务器依然能够继续提供服务。

Redis 主从复制（replication）功能，能够实现自动将更新的数据同步到其他服务器上。

主从复制中，**主数据库能够支持读写**操作，写操作会自动同步给从数据库。

**从数据库一般是只读**的，并**接受主数据库同步过来的数据**。

一个**主数据库可以拥有多个从数据库**，而一个**从数据库只能拥有一个主数据库**。

### 工作过程

+ 从数据库启动成功后，连接主数据库，发送 SYNC 命令。
+ 主数据库接收到 SYNC 命令后，开始执行 BGSAVE 命令生成 RDB 文件，并**使用缓冲区记录此后执行的所有写命令**。
+ 主数据库 BGSAVE 执行完后，向所有从数据库发送快照文件，并在发送期间继续记录被执行的写命令。
+ 主数据库快照发送完毕后，开始向从数据库发送缓冲区中的写命令。
+ 从数据库完成对快照的载入，开始接收命令请求，并执行来自主数据库缓冲区的写命令。
+ 主数据库每执行一个写命令就会向从数据库发送相同的写命令，从数据库接收并执行收到的写命令。
+ 主从建立连接之初，使用全量同步，全量同步结束后，后续使用增量同步。slave 在任何时候都可以发起全量同步。Redis 的策略首先会尝试进行增量同步，如不成功，进行全量同步。
+ 如果出现中断重连，2.8之后的版本会将掉线期间的命令传给从数据库。

```text
从库 -> SYNC >>>> 主库
主库 -> BGSAVE >>> RDB 文件 , 缓冲区记录
主库 >>>> 快照/全量 >>>> 从库
主库 >>>> 增量 >>>> 从库 
```

**此模式在扩容和容错方面不理想。**

## Sentinel（哨兵）模式

哨兵节点运行一个名为"redis-sentinel"的程序，其功能与普通的Redis服务器不同。

哨兵节点通过Gossip协议和PING/PONG机制与其他哨兵节点进行通信，用于发现节点的状态变化和传播集群的拓扑信息。

哨兵节点会监控Redis主节点和从节点的状态，当发现主节点不可用时，会执行故障转移操作，将一个从节点晋升为新的主节点。

每个哨兵节点都有一个配置文件，其中包含了集群中的节点信息、监控设置、故障转移策略等配置项。在

配置文件中，可以指定要监控的Redis节点、故障转移的条件和策略，以及其他相关的参数。

### 工作过程

主从同步/复制的模式在主服务器宕机后，需要人工干预将从服务器切换成主服务器，哨兵模式应运而生。

哨兵模式是一种特殊的模式，所以有独立的**哨兵的命令**。

哨兵是一个独立的进程，通过发送命令，等待Redis服务器响应，以此监控 Redis （主服务器和从服务器）运行的状态。

当哨兵监测到 master 宕机，会自动将 slave 切换成 master。

然后通过**发布订阅模式**通知其他的从服务器，修改配置文件，将连接切换到主服务器。

单个哨兵进程也可能会出现问题，为此，可以使用多个哨兵进行监控。哨兵之间还会进行监控，就此形成多哨兵模式。

假设主服务器宕机，其中一个哨兵检测到结果，并不会马上进行 failover 过程，。当其他哨兵也检测到主服务器不可用时，且数量达到一定值时，哨兵之间会进行一次投票，结果由一个哨兵发起，进行 failover 操作。

切换成功后，就会通过发布订阅模式通知其他哨兵。



```text
哨兵 >> 监测命令(SENTINEL masters) >> master
哨兵 >> 监测命令(SENTINEL slaves)  >> slave

哨兵 >>>>  选举 >>>> Leader >>>> 协调故障转移
哨兵Leader >>  通知（发布订阅（Pub/Sub）） >> slaves
```

## 工作过程

+ 每个Sentinel（哨兵）进程以每秒钟一次的频率向整个集群中的 Master 主服务器。
+ 如果一个实例（instance）距离最后一次有效回复 PING 命令的时间超过 down-after-milliseconds 选项所指定的值， 则这个实例会被 Sentinel（哨兵）进程标记为主观下线（SDOWN）。
+ 当足够数量的 Sentinel（哨兵）进程（大于等于配置文件指定的值）在指定的时间范围内确认 Master 主服务器进入了主观下线状态（SDOWN）， 则 Master 主服务器会被标记为客观下线（ODOWN）。
+ 通常每个 Sentinel（哨兵）进程会以每 10 秒一次的频率向集群中的所有实例发送 INFO 命令。
+ 当 Master 主服务器被 Sentinel（哨兵）进程标记为客观下线（ODOWN）时，Sentinel（哨兵）进程向所有从服务器发送 INFO 命令的会从 10 秒一次改为每秒一次。
+ 如果没有足够数量的 Sentinel（哨兵）进程同意主服务器下线，主服务器的**客观下线**状态就会被移除。如果主服务器重新向 Sentinel（哨兵）进程发送 PING 命令返回有效回复，Master主服务器的主观下线状态就会被移除。

**该模式在线扩容比较困难，集群容量达到上限时在线扩容会变得很复杂。**

## Cluster 模式

Redis Cluster是3.0版本开始正式提供的一种服务器 Sharding 技术。
哨兵模式能够实现高可用，读写分离 ，但是一份数据在多个服务器中存储并不环保，3.0版本实现了分布式存储。

### 角色：
#### 主节点（Master）： 
主节点是Redis Cluster中负责处理客户端读写请求和数据写入的节点。每个主节点都有一个或多个从节点。

#### 从节点（Slave）： 

从节点是主节点的备份节点，在主节点的基础上进行数据复制。从节点不处理客户端的写入请求，而是只负责响应客户端的读取请求，并从主节点同步数据。

#### 哨兵节点（Sentinel）： 

哨兵节点不直接参与数据的存储和读写，它们起着监控和管理的角色。哨兵节点负责监控Redis节点的状态，发现节点故障，执行故障转移操作，并管理集群的拓扑变化，包括新增节点、移除节点、Rehash和分配哈希槽等。

### 工作过程

在该模式中任何两个节点之间都是相互连通的，客户端可以与任何一个节点相连接，就能访问集群中的任意节点，进行存取和其他操作。

为了保证高可用，该模式引入了主从复制模型，一个主节点对应一个或多个从节点，主节点宕机时，会启用从节点。

当其它主节点 ping 一个主节点时，半数以上收到通信超时的反馈后，会认为该主节点宕机了。如果主节点和它的从节点都宕机了，该集群就无法再提供服务了。

在Redis Cluster中，各节点之间通过Gossip协议和PING/PONG机制来发现节点的状态变化，包括节点的删除和新增。

```text
分片策略：

客户端 -> hash -> 主节点 -> sync -> 从节点

Gossip协议 -> 维护节点 -> 发现增加/删除 -> 数据槽迁移 
```

## Redis数据分片

数据分片（sharding）是一种将一个Redis数据集分割成多个部分，分别存储在Redis各节点上。

数据分片实现方式通常是将数据按照某种规则（如，key的hash值）分配到不同的节点上。

客户端访问某个key时，会先计算出个key存储在哪个节点上，然后连接到该节点进行操作。对于客户端而言，无需要关心数据的实际分布情况。

Cluster 集群模式中，使用哈希槽（hash slot）方式来进行数据分片。Redis Cluster将整个数据集划分为**16384**个槽。

当我们的存取的 Key 的时候，Redis 会根据**CRC16**算法，计算出一个结果，然后用结果对 16384 求余数，就得出该 key 对应的哈希槽，通过哈希槽找到对应的节点，然后跳对应的节点进行存取操作。

**16384**是一个2的14次方（2^14），Redis Cluster将整个哈希空间划分为16384个子区间，主要出于**易于扩展**、易于计算、负载更均衡。











